<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>OUTILS JUSTIFIT</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --brand:#001d50;
      --brand-2:#4c7b7b;
      --accent:#66a2a0;
      --gold:#ffd700;
      --bg:#f3f5f7;
      --card:#001d50;
      --codebg:#f0f4f8;
      --text:#333;
      --white:#fff;
      --success:#4caf50;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:flex-start;
      background:var(--bg); color:var(--text); font-family:Arial, sans-serif; position:relative;
    }
    .navbar{
      position:fixed; top:0; left:0; width:100%; z-index:1000;
      background:var(--brand); padding:10px 0; text-align:center;
    }
    .navbar a{
      color:var(--white); text-decoration:none; font-weight:bold; padding:10px 20px; display:inline-block;
    }
    .navbar a:hover{ background:var(--brand-2); border-radius:5px; }
    .container1{
      width:min(900px, 92vw);
      background:var(--card); color:var(--white);
      margin-top:70px; padding:28px; border-radius:12px;
      box-shadow:0 4px 12px rgba(0,0,0,.1);
    }
    h1{
      color:var(--gold); text-align:center; font-size:26px; margin:0 0 14px;
    }
    h2{ color:var(--white); text-align:center; margin:0 0 18px; font-weight:600; font-size:20px; }
    label{ display:block; font-weight:600; margin-top:14px; color:var(--white); }
    textarea{
      width:100%; height:420px; padding:12px; margin-top:10px; border-radius:6px; border:1px solid #ced4da;
      font-size:14px; font-family: Consolas, "Courier New", monospace; background:#fff; color:#222;
    }
    .row{ display:grid; grid-template-columns: 1fr; gap:12px; margin-top:10px; }
    input[type="button"], button{
      width:100%; background:var(--accent); color:var(--white); border:none; border-radius:8px;
      padding:12px 16px; cursor:pointer; font-weight:700; font-size:16px; transition:.25s ease background;
    }
    input[type="button"]:hover, button:hover{ background:var(--brand-2); }
    .actions{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px; }
    .notification{
      position:fixed; top:20px; left:50%; transform:translateX(-50%);
      background:var(--success); color:var(--white); padding:10px 16px; border-radius:6px; font-size:14px;
      opacity:0; visibility:hidden; transition:opacity .3s ease, visibility .3s ease; z-index:10;
    }
    .notification.show{ opacity:1; visibility:visible; }
    #generatedCodeContainer{
      margin-top:18px; padding:16px; background:var(--codebg); color:#333; border-radius:8px;
      font-size:14px; font-family:'Courier New', Courier, monospace; display:none; white-space:pre-wrap; word-break:break-word;
    }
    #generatedCodeContainer::before{
      content:"Votre code ici :"; font-weight:bold; display:block; margin-bottom:10px; color:var(--brand);
    }

    /* Styles de sortie ciblés (prévisualisation sémantique, pas obligatoire) */
    .bloc-bonsavoir{ border:1px solid #e6e8ec; background:#fff; color:#222; border-radius:10px; padding:12px; margin:12px 0; }
    .title-bonsavoir{ font-weight:700; margin-bottom:6px; color:#0b2a6f; }
    .desc-bonsavoir{ line-height:1.5; }
    blockquote{ border-left:4px solid #0b2a6f; margin:12px 0; padding:8px 12px; background:#f7f9ff; }
    blockquote strong{ display:block; margin-bottom:6px; }
    footer{ margin:16px 0; font-size:.85rem; color:#999; text-align:center; }
    .muted{ opacity:.82; font-size:.92em; }
  </style>
</head>
<body>

<div class="notification" id="notification">Texte copié dans le presse-papiers !</div>

<div class="container1">
  <h1>OUTILS JUSTIFIT</h1>

  <div class="navbar">
    <a href="index.html">Call To Action</a>
    <a href="ctabouton.html">CTA Bouton</a>
    <a href="majusculeconvert.html">Convers MAJ</a>
    <a href="nofollowcode.html">No Follow</a>
    <a href="sourcearticle.html">Source</a>
    <a href="promptjuridique.html">ANCIEN OUTIL</a>
  </div>

  <h2 class="muted">Encapsule automatiquement les blocs “CTA”, Key takeaways et Sources</h2>

  <form onsubmit="return false;">
    <label for="question">Collez votre texte [code source] ici :</label>
    <textarea id="question" name="question" placeholder="Ex. : &lt;p&gt;&lt;strong&gt;Bon à savoir :&lt;/strong&gt; Le dépôt d’une main courante est gratuit...&lt;/p&gt;"></textarea>

    <div class="actions">
      <input type="button" value="Générer & Copier" onclick="runTool()">
      <button type="button" onclick="downloadHtml()">Télécharger .html</button>
    </div>
  </form>

  <div id="generatedCodeContainer"></div>
</div>

<footer>&copy; RoberiX 2025</footer>

<link rel="stylesheet" href="./assets/chat-widget/chat-widget.css">
<script>window.JF_CHAT_ASSET_BASE="./assets/chat-widget/";</script>
<script src="./assets/chat-widget/chat-widget.js"></script>

<script>
/* ============================
   OUTILS JUSTIFIT (robuste)
   - Vanilla JS, 100% client
   - Parsing DOM + regex tolérantes
   - Table de mapping pour normaliser les titres
   ============================ */

/** 1) Libellés CTA que l’on détecte (FR & UK)
 *  On reste proche de ta liste existante, mais la détection est plus souple.
 */
const CALLOUT_LABELS = [
  // FR
  "Bon à savoir","À noter","A noter","À savoir","A savoir","Important","Nos conseils","Conseils","Attention","Remarque","À retenir","A retenir",
  // EN / UK
  "Key takeaways","Key takeaway","Advice","Tip","Pro tip","Good to know","Strategic insight","Strategic tip","Remember","Beware","Caution","Did you know",
  "Exception","Insight","Noteworthy","Key consideration","Prudent approach","Practical consideration","Consideration","Power tip","Negotiation tip","Word to the wise",
  "Enforcement insight","Cost insight","Evidence protection tip","Evidence tip","Compensation insight","Defence strategy tip","Access to justice tip","Expert insight"
];

/** 2) Libellés fin d’article → blockquote */
const TAKEAWAYS_LABELS = [
  "Points clés à retenir","À retenir","A retenir","Key takeaways","Key takeaway","Key Takeaways","Key Takeaway"
];

/** 3) Mapping d’affichage (normalisation visuelle)
 *  Si un libellé est détecté, on applique ce mapping pour le Titre (ex. Tip → TIP).
 *  Ajoute / ajuste ce que tu veux.
 */
const LABEL_DISPLAY_MAP = new Map([
  // FR
  ["Bon à savoir","BON À SAVOIR"],
  ["À noter","À NOTER"], ["A noter","À NOTER"],
  ["À savoir","À SAVOIR"], ["A savoir","À SAVOIR"],
  ["Important","IMPORTANT"],
  ["Nos conseils","NOS CONSEILS"], ["Conseils","CONSEILS"],
  ["Attention","ATTENTION"],
  ["Remarque","REMARQUE"],
  ["À retenir","À RETENIR"], ["A retenir","À RETENIR"],
  ["Points clés à retenir","POINTS CLÉS À RETENIR"],

  // EN / UK
  ["Key takeaways","KEY TAKEAWAYS"], ["Key takeaway","KEY TAKEAWAY"],
  ["Advice","ADVICE"],
  ["Tip","TIP"], ["Pro tip","PRO TIP"],
  ["Good to know","GOOD TO KNOW"],
  ["Strategic insight","STRATEGIC INSIGHT"], ["Strategic tip","STRATEGIC TIP"],
  ["Remember","REMEMBER"], ["Beware","BEWARE"], ["Caution","CAUTION"],
  ["Did you know","DID YOU KNOW"],
  ["Exception","EXCEPTION"], ["Insight","INSIGHT"], ["Noteworthy","NOTEWORTHY"],
  ["Key consideration","KEY CONSIDERATION"],
  ["Prudent approach","PRUDENT APPROACH"],
  ["Practical consideration","PRACTICAL CONSIDERATION"],
  ["Consideration","CONSIDERATION"],
  ["Power tip","POWER TIP"], ["Negotiation tip","NEGOTIATION TIP"],
  ["Word to the wise","WORD TO THE WISE"],
  ["Enforcement insight","ENFORCEMENT INSIGHT"],
  ["Cost insight","COST INSIGHT"],
  ["Evidence protection tip","EVIDENCE PROTECTION TIP"], ["Evidence tip","EVIDENCE TIP"],
  ["Compensation insight","COMPENSATION INSIGHT"],
  ["Defence strategy tip","DEFENCE STRATEGY TIP"],
  ["Access to justice tip","ACCESS TO JUSTICE TIP"],
  ["Expert insight","EXPERT INSIGHT"]
]);

/** 4) Motifs d’URL pour le shortcode [ctabtn] (reprend ta logique) */
const CTA_URL_PATTERNS = [
  /https:\/\/www\.justifit\.fr\/avocats\/q\/[^\s"']+/gi,
  /https:\/\/www\.justifit\.fr\/trouver\/avocats\/france\/[^\s"']+/gi,
];

function normalizeText(text){
  return (text||"").replace(/\u00A0/g," ").replace(/\s+/g," ").trim();
}
function escapeRe(s){ return s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"); }

/** Détermine si un bloc commence par un “label” (avec ou sans “:”, avec/ sans <strong>, casse indifférente) */
function startsWithLabelHTML(html, label){
  const L = escapeRe(label);
  const pattern = `^(?:<strong>\\s*)?${L}\\s*:?(?:\\s*<\\/strong>)?\\s*`;
  return new RegExp(pattern,"i").test((html||"").trim());
}
/** Retire le libellé détecté du début du HTML d’un paragraphe */
function stripLeadingLabelHTML(html, label){
  const L = escapeRe(label);
  const re = new RegExp(`^(?:<strong>\\s*)?${L}\\s*:?(?:\\s*<\\/strong>)?\\s*`,"i");
  return (html||"").trim().replace(re,"");
}
/** Met en forme le libellé selon le mapping ; sinon uppercasing simple + “ : ” */
function formatDisplayLabel(label){
  if (LABEL_DISPLAY_MAP.has(label)) return LABEL_DISPLAY_MAP.get(label);
  return label.toUpperCase();
}
function findAllCtaUrls(html){
  const urls = new Set();
  CTA_URL_PATTERNS.forEach(re => (html.match(re)||[]).forEach(u => urls.add(u)));
  return Array.from(urls);
}

/** Wrap générique pour CTA block */
function wrapCalloutBlock(doc, node, usedLabel, contentHTML){
  const wrapper = doc.createElement("div");
  wrapper.className = "bloc-bonsavoir";
  const title = doc.createElement("div");
  title.className = "title-bonsavoir";
  title.innerHTML = `<strong>${formatDisplayLabel(usedLabel)} :</strong>`;
  const body = doc.createElement("div");
  body.className = "desc-bonsavoir";
  body.innerHTML = contentHTML;
  wrapper.appendChild(title); wrapper.appendChild(body);
  node.replaceWith(wrapper);
}

/** Blockquote “takeaways” (fin d’article) + CTA optionnel */
function wrapTakeaways(doc, startNode, label, ctaUrl){
  const block = doc.createElement("blockquote");
  const title = doc.createElement("strong");
  title.textContent = `${formatDisplayLabel(label)} :`;
  block.appendChild(title);

  // Cherche UL qui suit, sinon 1 paragraphe voisin
  let cursor = startNode.nextSibling, collected=false;
  while(cursor){
    if (cursor.nodeType === 1){
      const tag = cursor.tagName.toLowerCase();
      if (tag === "ul"){
        block.appendChild(cursor.cloneNode(true));
        collected=true; break;
      } else if (["p","div","br"].includes(tag)){
        block.appendChild(cursor.cloneNode(true));
        collected=true; break;
      } else { break; }
    } else if (cursor.nodeType === 3){
      const txt = normalizeText(cursor.textContent);
      if (txt){
        const p = doc.createElement("p"); p.textContent = txt;
        block.appendChild(p); collected=true;
      }
      break;
    } else break;
  }

  const frag = doc.createDocumentFragment();
  if (ctaUrl){
    frag.appendChild(doc.createTextNode(
      `[ctabtn url="${ctaUrl}" text="Trouvez mon avocat" target="_blank" follow="follow" color="blue"]`
    ));
  }
  frag.appendChild(block);
  startNode.replaceWith(frag);

  if (!collected){
    const p = doc.createElement("p"); p.textContent = "";
    block.appendChild(p);
  }
}

/** Transforme le HTML d’entrée en HTML formaté */
function transformHTML(inputHTML){
  const src = normalizeText(inputHTML);
  const container = document.createElement("div");
  container.innerHTML = src;

  // CTA URLs (toutes) ; on utilisera la 1ère pour le shortcode (comme avant)
  const allHtml = container.innerHTML;
  const ctaUrls = findAllCtaUrls(allHtml);
  const firstCta = ctaUrls[0] || null;

  // 1) Parcours des nœuds paragraphe-like
  const nodes = Array.from(container.querySelectorAll("p, div"));
  nodes.forEach(node => {
    const raw = node.innerHTML;
    const textNorm = normalizeText(raw);

    // détection labels
    for (const label of CALLOUT_LABELS){
      if (startsWithLabelHTML(raw, label) || new RegExp(`^${escapeRe(label)}$`,"i").test(textNorm)){
        // Si c’est un “takeaways”, on laisse à l’étape 2
        if (TAKEAWAYS_LABELS.some(t => new RegExp(`^${escapeRe(t)}$`,"i").test(label))) break;

        const contentHTML = stripLeadingLabelHTML(raw, label);
        wrapCalloutBlock(container.ownerDocument, node, label, contentHTML);
        return; // nœud remplacé, on arrête ici
      }
    }
  });

  // 2) Takeaways (fin d’article)
  const nodes2 = Array.from(container.querySelectorAll("p, div, h2, h3, h4, strong"));
  nodes2.forEach(node => {
    const raw = node.innerHTML || node.textContent || "";
    const textNorm = normalizeText(raw);
    for (const label of TAKEAWAYS_LABELS){
      if (startsWithLabelHTML(raw, label) || new RegExp(`^${escapeRe(label)}$`,"i").test(textNorm)){
        wrapTakeaways(container.ownerDocument, node, label, firstCta);
        return;
      }
    }
  });

  // 3) “Sources” → shortcode [article_sources list="…"] (reprend ta mécanique)
  container.innerHTML = container.innerHTML.replace(
    /<strong>\s*Sources\s*:?\s*<\/strong>([\s\S]*?)(?=<strong>|$)/gi,
    (m, content) => {
      const links = Array.from(content.matchAll(/<a\s+href="([^"]+)".*?>(.*?)<\/a>/gi));
      if (!links.length) return "";
      const formatted = links.map(([,href])=>{
        try{ return `${new URL(href).hostname.replace(/^www\./,"")} -- ${href}`; }
        catch{ return href; }
      }).join(" | ");
      return `[article_sources list="${formatted}"]`;
    }
  );

  return container.innerHTML;
}

/** UI */
function runTool(){
  const src = document.getElementById("question").value || "";
  const result = transformHTML(src);

  const out = document.getElementById("generatedCodeContainer");
  out.textContent = result;
  out.style.display = "block";

  if (navigator.clipboard?.writeText){
    navigator.clipboard.writeText(result).then(showNotification).catch(()=>legacyCopy(result));
  }else{
    legacyCopy(result);
  }
}
function legacyCopy(text){
  const ta = document.createElement("textarea");
  ta.value = text; document.body.appendChild(ta); ta.select();
  document.execCommand("copy"); ta.remove(); showNotification();
}
function showNotification(){
  const n = document.getElementById("notification");
  n.classList.add("show"); setTimeout(()=>n.classList.remove("show"), 2000);
}
function downloadHtml(){
  const code = document.getElementById("generatedCodeContainer").textContent || "";
  const blob = new Blob([code], {type:"text/html;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "sortie-justifit.html"; a.click();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
}
</script>
</body>
</html>
